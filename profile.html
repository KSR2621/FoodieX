    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, updatePassword, signOut, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getDatabase, ref, get, set, update, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

        // ... (firebaseConfig and other const declarations remain the same) ...
        // ... (all your element getters remain the same) ...

        document.getElementById('current-year').textContent = new Date().getFullYear();

        let currentUser = null;
        let currentUserDbData = null;
        let currentDbListener = null;
        let currentRestaurantFoodsUnsubscribe = null;
        let currentRestaurantDailyMenuUnsubscribe = null;
        let allRoFoods = [];

        // ... (compressAndEncodeImage, showFeedback, openConfirmationModal, modalDialog listeners remain the same) ...
        // ... (dashboardLogoutBtn listener remains the same) ...
        // ... (populateSidebar, handleNavClick, setActiveDashboardPanel, mobile menu listeners remain the same) ...
        // ... (displayUserProfileInfo, displayUserFavorites, userFavoritesListContainer listener remain the same) ...
        // ... (displayRoProfileInfo, setupRoDailyMenuManagement logic remains the same) ...

        function renderRoFoodItems(foodsToRender) {
            // ... (this function remains the same) ...
        }

        dashboardRoMenuItemsSearch.addEventListener('input', (e) => {
            // ... (this listener remains the same) ...
        });

        // --- MODIFICATION START: Move roFoodItemForm submit listener here ---
        roFoodItemForm.addEventListener('submit', async e => {
            e.preventDefault();

            if (!currentUser || !currentUserDbData || currentUserDbData.role !== 'restaurant') {
                showFeedback(roFoodItemFormFeedback, 'Not authorized or user data not loaded. Please ensure you are logged in as a restaurant.', false);
                return;
            }

            roFoodItemFormFeedback.textContent = ''; // Clear previous feedback
            const foodIdToEdit = roFoodItemFormId.value;
            let imageBase64 = '';
            if (roFoodItemFormImage.files[0]) {
                try { imageBase64 = await compressAndEncodeImage(roFoodItemFormImage.files[0]); }
                catch (imgErr) { showFeedback(roFoodItemFormFeedback, imgErr.message, false); return; }
            }

            const foodData = {
                name: roFoodItemFormName.value.trim(),
                description: roFoodItemFormDescription.value.trim(),
                category: roFoodItemFormCategory.value.trim(),
                price: parseFloat(roFoodItemFormPrice.value),
                status: roFoodItemFormStatus.value
            };

            if (isNaN(foodData.price) || foodData.price < 0) {
                showFeedback(roFoodItemFormFeedback, 'Please enter a valid non-negative price.', false);
                return;
            }
            if (!foodData.name) {
                showFeedback(roFoodItemFormFeedback, 'Food name is required.', false);
                return;
            }

            if (imageBase64) {
                 foodData.imageBase64 = imageBase64;
            }

            try {
                const restaurantId = currentUser.uid; // Use the currently logged-in restaurant's UID

                if (foodIdToEdit) { // Editing existing item
                    if (!imageBase64 && roFoodItemFormImage.files.length === 0) { // If no new image, try to preserve old one
                        const existingFoodSnap = await get(ref(database, `restaurants/${restaurantId}/foods/${foodIdToEdit}`));
                        if(existingFoodSnap.exists() && existingFoodSnap.val().imageBase64) {
                            foodData.imageBase64 = existingFoodSnap.val().imageBase64; // Keep existing image
                        } else {
                            foodData.imageBase64 = ''; // No existing image or clear it
                        }
                    }
                    await update(ref(database, `restaurants/${restaurantId}/foods/${foodIdToEdit}`), foodData);
                    showFeedback(roFoodItemFormFeedback, 'Food item updated!', true);
                } else { // Adding new item
                    if (!foodData.imageBase64) foodData.imageBase64 = ''; // Ensure imageBase64 property exists even if empty
                    await push(ref(database, `restaurants/${restaurantId}/foods`), foodData);
                    showFeedback(roFoodItemFormFeedback, 'Food item added!', true);
                }
                roFoodItemForm.reset(); roFoodItemFormId.value = '';
                roFoodItemFormImage.value = ''; // Explicitly clear file input
                roFoodItemFormTitle.textContent = 'Add New Food Item';
                roFoodItemFormSubmitBtn.textContent = 'Add Food Item';
                roAddEditFoodFormContainer.classList.add('hidden-important');
                dashboardHeaderActionBtn.innerHTML = '<i class="fas fa-plus"></i>Add New Item';
            } catch (err) {
                showFeedback(roFoodItemFormFeedback, 'Operation failed: ' + err.message, false);
            }
        });
        // --- MODIFICATION END: Moved roFoodItemForm submit listener ---


        function setupRoFoodItemManagement(restaurantId) {
            if (currentRestaurantFoodsUnsubscribe) currentRestaurantFoodsUnsubscribe();
            const foodsRefDB = ref(database, `restaurants/${restaurantId}/foods`);
            currentRestaurantFoodsUnsubscribe = onValue(foodsRefDB, snapshot => {
                allRoFoods = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        if (typeof data === 'object' && data !== null) {
                             allRoFoods.push({ id: childSnapshot.key, data: data });
                        } else {
                            console.warn("Invalid food item data structure from Firebase:", childSnapshot.key, data);
                        }
                    });
                }
                renderRoFoodItems(allRoFoods);
                dashboardRoMenuItemsSearch.value = ''; // Reset search on new data load
            }, error => {
                console.error("Error loading RO food items: ", error);
                roFoodsListContainer.innerHTML = '<tr><td colspan="5" class="text-red-500 text-center py-4">Could not load food items.</td></tr>';
                allRoFoods = [];
            });

            // THE SUBMIT LISTENER WAS HERE, IT'S NOW MOVED OUTSIDE THIS FUNCTION
            // roFoodItemForm.addEventListener('submit', async e => { ... }); // REMOVE FROM HERE
        }

        roFoodsListContainer.addEventListener('click', async e => {
            // ... (this listener remains the same, ensure it uses `currentUser.uid` for database paths) ...
            const editBtn = e.target.closest('.edit-ro-food-item-btn');
            const deleteBtn = e.target.closest('.delete-ro-food-item-btn');
            if (editBtn) {
                const foodId = editBtn.dataset.id;
                if (!currentUser || !currentUser.uid) { // Ensure currentUser is available
                    showFeedback(roFoodItemFormFeedback, 'User not logged in.', false);
                    return;
                }
                try {
                    const foodSnap = await get(ref(database, `restaurants/${currentUser.uid}/foods/${foodId}`)); // Use currentUser.uid
                    if (foodSnap.exists()) {
                        // ... rest of edit logic
                        const food = foodSnap.val();
                        roFoodItemFormId.value = foodId;
                        roFoodItemFormName.value = food.name || '';
                        roFoodItemFormDescription.value = food.description || '';
                        roFoodItemFormCategory.value = food.category || '';
                        roFoodItemFormPrice.value = food.price !== undefined ? food.price : '';
                        roFoodItemFormStatus.value = food.status || 'Available';
                        roFoodItemFormImage.value = '';
                        roFoodItemFormTitle.textContent = 'Edit Food Item';
                        roFoodItemFormSubmitBtn.textContent = 'Update Food Item';
                        roAddEditFoodFormContainer.classList.remove('hidden-important');
                        dashboardHeaderActionBtn.innerHTML = '<i class="fas fa-times"></i>Cancel Editing';
                        roAddEditFoodFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        roFoodItemFormFeedback.textContent = '';
                    } else {
                        showFeedback(roFoodItemFormFeedback, 'Could not find item to edit.', false);
                    }
                } catch (err) {
                     showFeedback(roFoodItemFormFeedback, 'Error fetching item: ' + err.message, false);
                }
            } else if (deleteBtn) {
                const foodId = deleteBtn.dataset.id;
                if (!currentUser || !currentUser.uid) { // Ensure currentUser is available
                    showFeedback(roFoodItemFormFeedback, 'User not logged in.', false);
                    return;
                }
                openConfirmationModal('Delete Food Item', 'Are you sure you want to delete this food item?', async () => {
                    try {
                        await remove(ref(database, `restaurants/${currentUser.uid}/foods/${foodId}`)); // Use currentUser.uid
                        showFeedback(roFoodItemFormFeedback, 'Food item deleted!', true);
                    } catch (err) {
                        showFeedback(roFoodItemFormFeedback, 'Delete failed: ' + err.message, false);
                    }
                });
            }
        });

        dashboardHeaderActionBtn.addEventListener('click', () => {
            // ... (this listener remains the same) ...
        });

        // ... (editUserProfileToggleBtn listener, updateUserProfileDetailsForm listener remain the same) ...
        // ... (editRoRestaurantToggleBtn listener, updateRoRestaurantDetailsForm listener remain the same) ...
        // ... (commonChangePasswordForm listener, commonForgotPasswordLink listener remain the same) ...

        onAuthStateChanged(auth, async (user) => {
            // ... (this function largely remains the same, ensure currentUser is set correctly) ...
            // ... The calls to setupRoFoodItemManagement will no longer re-attach the problematic listener ...
            currentUser = user;

            if (currentDbListener) { currentDbListener(); currentDbListener = null; }
            if (currentRestaurantFoodsUnsubscribe) { currentRestaurantFoodsUnsubscribe(); currentRestaurantFoodsUnsubscribe = null; }
            if (currentRestaurantDailyMenuUnsubscribe) { currentRestaurantDailyMenuUnsubscribe(); currentRestaurantDailyMenuUnsubscribe = null; }

            allDashboardPanels.forEach(panel => panel.classList.add('hidden-important'));
            roAddEditFoodFormContainer.classList.add('hidden-important');

            authRequiredPrompt.classList.add('hidden-important');
            unifiedDashboardContainer.classList.add('hidden-important');

            if (user) {
                unifiedDashboardContainer.classList.remove('hidden-important');
                const userRef = ref(database, `users/${user.uid}`);
                currentDbListener = onValue(userRef, (userSnapshot) => {
                    if (userSnapshot.exists() && userSnapshot.val().role === 'user') {
                        currentUserDbData = { uid: user.uid, ...userSnapshot.val() };
                        sidebarUsernameRestaurantName.textContent = currentUserDbData.name || 'Customer';
                        populateSidebar('user');
                        displayUserProfileInfo(currentUserDbData);

                        let favoriteRestaurantIds = [];
                        if (currentUserDbData.favorites && typeof currentUserDbData.favorites === 'object' && !Array.isArray(currentUserDbData.favorites)) {
                            favoriteRestaurantIds = Object.keys(currentUserDbData.favorites);
                        } else if (Array.isArray(currentUserDbData.favorites)) {
                            favoriteRestaurantIds = currentUserDbData.favorites;
                        }
                        displayUserFavorites(favoriteRestaurantIds);

                        if (dashboardSidebarNavList.firstChild?.querySelector('a')) {
                            const currentActivePanelId = Array.from(dashboardSidebarNavList.querySelectorAll('a')).find(a => a.classList.contains('active'))?.dataset.panel;
                            if (!currentActivePanelId || !document.getElementById(currentActivePanelId) || document.getElementById(currentActivePanelId).classList.contains('hidden-important')) {
                                dashboardSidebarNavList.firstChild.querySelector('a').click();
                            } else {
                               setActiveDashboardPanel(currentActivePanelId, document.getElementById(currentActivePanelId).querySelector('.panel-main-title')?.textContent || dashboardSidebarNavList.querySelector(`a[data-panel="${currentActivePanelId}"]`).dataset.title);
                            }
                        }

                    } else {
                        const restaurantRef = ref(database, `restaurants/${user.uid}`);
                        if (currentDbListener) { currentDbListener(); currentDbListener = null; }
                        currentDbListener = onValue(restaurantRef, (restoSnapshot) => {
                            if (restoSnapshot.exists()) {
                                currentUserDbData = { uid: user.uid, role: 'restaurant', ...restoSnapshot.val() };
                                sidebarUsernameRestaurantName.textContent = currentUserDbData.name || 'Restaurant Owner';
                                populateSidebar('restaurant');
                                displayRoProfileInfo(currentUserDbData);
                                setupRoDailyMenuManagement(user.uid);
                                setupRoFoodItemManagement(user.uid); // This is fine now
                                if (dashboardSidebarNavList.firstChild?.querySelector('a')) {
                                    const currentActivePanelId = Array.from(dashboardSidebarNavList.querySelectorAll('a')).find(a => a.classList.contains('active'))?.dataset.panel;
                                     if (!currentActivePanelId || !document.getElementById(currentActivePanelId) || document.getElementById(currentActivePanelId).classList.contains('hidden-important')) {
                                       dashboardSidebarNavList.firstChild.querySelector('a').click();
                                    } else {
                                        setActiveDashboardPanel(currentActivePanelId, document.getElementById(currentActivePanelId).querySelector('.panel-main-title')?.textContent || dashboardSidebarNavList.querySelector(`a[data-panel="${currentActivePanelId}"]`).dataset.title);
                                    }
                                }
                            } else {
                                console.warn("User signed in, but no 'user' role in users/ DB and no data in restaurants/ DB. Prompting to complete profile or defaulting.");
                                currentUserDbData = { uid: user.uid, role: 'user', email: user.email, name: user.displayName || "New User", favorites: {} };
                                sidebarUsernameRestaurantName.textContent = currentUserDbData.name;
                                populateSidebar('user');
                                displayUserProfileInfo(currentUserDbData);
                                displayUserFavorites([]);
                                if (dashboardSidebarNavList.firstChild?.querySelector('a')) {
                                     dashboardSidebarNavList.firstChild.querySelector('a').click();
                                }
                            }
                        }, (error) => {
                             console.error("Error listening to restaurant data:", error);
                             authRequiredPrompt.classList.remove('hidden-important');
                             unifiedDashboardContainer.classList.add('hidden-important');
                        });
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    authRequiredPrompt.classList.remove('hidden-important');
                    unifiedDashboardContainer.classList.add('hidden-important');
                });
            } else {
                currentUserDbData = null;
                allRoFoods = [];
                roFoodsListContainer.innerHTML = '';
                authRequiredPrompt.classList.remove('hidden-important');
                unifiedDashboardContainer.classList.add('hidden-important');
            }
        });
    </script>
</body>
</html>
